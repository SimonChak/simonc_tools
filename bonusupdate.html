<!DOCTYPE html>
<html>
<head>
    <title>Bonus Updateæ•¸æ“šæ¯”è¼ƒå·¥å…·</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f8ff; }
        .container { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 20px; max-width: 2000px; margin: 0 auto; }
        .section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 300px; padding: 10px; border: 2px solid #007bff; border-radius: 5px; font-family: monospace; }
        button { background: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 2px solid #ddd; padding: 10px; text-align: center; }
        th { background: #e9ecef; font-weight: bold; }
        .debug-info { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .result-table { background: #f8f9fa; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        .not-found { background: #fff3cd; }
        .hidden { display: none; }
        .increase { color: green; font-weight: bold; }
        .decrease { color: red; font-weight: bold; }
        .no-change { color: blue; font-weight: bold; }
        .expired { color: #999; text-decoration: line-through; }
        .no-product { color: #6c757d; font-weight: bold; }
        select { width: 100%; padding: 10px; border: 2px solid #007bff; border-radius: 5px; margin-bottom: 10px; }
        .select-group { margin-bottom: 15px; }
        .select-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 10px; border: 2px solid #007bff; border-radius: 5px; }
        #aDataInputs table input[type="number"] { width: 80%; }
        #aDataInputs { max-height: 500px; overflow-y: auto; }
        .method-select { width: 120px; }
        .add-product-btn { background: #28a745; margin: 10px 5px; }
        .add-product-btn:hover { background: #218838; }
        .delete-btn { background: #dc3545; padding: 5px 10px; margin-left: 5px; }
        .delete-btn:hover { background: #c82333; }
        .primary-btn { 
            background: #007bff; 
            font-weight: bold; 
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .primary-btn:hover { background: #0056b3; }
        .action-btn { 
            background: #6c757d; 
            font-weight: bold; 
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .action-btn:hover { background: #5a6268; }
        .important-btn { 
            background: #28a745; 
            font-weight: bold; 
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .important-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <h1>ğŸ” Bonus Update æ¯”è¼ƒå·¥å…·</h1>
    
    <div class="container">
        <div class="section">
            <h2>ğŸ“‹ Aæ•¸æ“šï¼ˆæ–°æ•¸å€¼ï¼‰</h2>
            
            <div id="aDataInputs">
                <table>
                    <tr>
                        <th>ç”¢å“</th>
                        <th>æ‰‹æ•¸</th>
                        <th>æ•¸å€¼</th>
                        <th>æ–¹æ³•</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    <tr>
                        <td>STD (æ¨™æº–)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="D" selected>Direct</option>
                                <option value="O">Override</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Forex (å¤–åŒ¯)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Gold (é»ƒé‡‘)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Silver (ç™½éŠ€)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Oil (åŸæ²¹)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GASUSD (å¤©ç„¶æ°£)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>HKG33 (æ’ç”ŸæŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>NAS100 (ç´æ–¯é”å…‹100æŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>SPX500 (æ¨™æ™®500æŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>US30 (é“ç“Šæ–¯æŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>A50 (ä¸­è¯A50æŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>JPN225 (æ—¥ç¶“225æŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GER30 (å¾·åœ‹DAXæŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GAUCNH (äººæ°‘å¹£é»ƒé‡‘)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>AUS200 (æ¾³æ´²200æŒ‡æ•¸)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>ECN (ECN)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </div>
            
            <button class="important-btn" onclick="collectAData()">æ”¶é›†Aæ•¸æ“š</button>
            <button class="action-btn" onclick="clearA()">æ¸…ç©ºAæ•¸æ“š</button>
            <button class="add-product-btn" onclick="addProductRow()">â• æ–°å¢ç”¢å“</button>
            
            <div id="aDataPreview" style="margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                <p>å°šæœªæ·»åŠ ä»»ä½•æ•¸æ“š</p>
            </div>
            
            <input type="hidden" id="tableA" value="">
        </div>

        <div class="section">
            <h2>ğŸ“‹ Bæ•¸æ“šï¼ˆåŸæ•¸å€¼ï¼‰</h2>
            <textarea id="tableB" placeholder="è«‹è²¼ä¸ŠBç¶²é çš„è¡¨æ ¼æ•¸æ“š..."></textarea>
        </div>

        <div class="section">
            <h2>ğŸ“‹ Cæ•¸æ“šï¼ˆä¸Šç·šæ•¸å€¼ï¼‰</h2>
            <textarea id="tableC" placeholder="è«‹è²¼ä¸ŠCç¶²é çš„è¡¨æ ¼æ•¸æ“š..."></textarea>
        </div>

        <div class="section" style="grid-column: 1 / -1;">
            <h2>ğŸ“Š è§£æèˆ‡æ ¸å°çµæœ</h2>
            <button class="important-btn" onclick="parseAndCheck()">é–‹å§‹è§£æèˆ‡æ ¸å°</button>
            <button class="action-btn" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
            
            <div id="finalResult"></div>
            <div id="debugResult"></div>
        </div>
    </div>

    <script>
        // ç”¢å“åç¨±æ˜ å°„è¡¨
        const productMapping = {
            'Forex': 'STD_FX',
            'å¤–åŒ¯': 'STD_FX',
            'Gold': 'STD_GOLD',
            'é»ƒé‡‘': 'STD_GOLD',
            'Silver': 'STD_SILVER',
            'ç™½éŠ€': 'STD_SILVER',
            'Oil': 'STD_OIL',
            'åŸæ²¹': 'STD_OIL',
            'GASUSD': 'STD_GAS',
            'å¤©ç„¶æ°£': 'STD_GAS',
            'HKG33': 'STD_HKG33',
            'æ’ç”ŸæŒ‡æ•¸': 'STD_HKG33',
            'NAS100': 'STD_NAS100',
            'ç´æ–¯é”å…‹100æŒ‡æ•¸': 'STD_NAS100',
            'SPX500': 'STD_SPX500',
            'æ¨™æ™®500æŒ‡æ•¸': 'STD_SPX500',
            'US30': 'STD_US30',
            'é“ç“Šæ–¯æŒ‡æ•¸': 'STD_US30',
            'A50': 'STD_A50',
            'ä¸­è¯A50æŒ‡æ•¸': 'STD_A50',
            'JPN225': 'STD_JPN225',
            'æ—¥ç¶“225æŒ‡æ•¸': 'STD_JPN225',
            'GER30': 'STD_GER30',
            'å¾·åœ‹DAXæŒ‡æ•¸': 'STD_GER30',
            'GAUCNH': 'STD_GAUCNH',
            'äººæ°‘å¹£é»ƒé‡‘': 'STD_GAUCNH',
            'AUS200': 'STD_AUS200',
            'æ¾³æ´²200æŒ‡æ•¸': 'STD_AUS200',
            'STD': 'STD',
            'æ¨™æº–': 'STD',
            '*': 'STD'
        };

        // å­˜å„²Aæ•¸æ“šçš„æ•¸çµ„
        let aData = [];

        // æ¨™æº–åŒ–ç”¢å“åç¨±
        function normalizeProductName(productName) {
            return productMapping[productName] || productName;
        }

        // æ–°å¢ç”¢å“è¡Œ
        function addProductRow() {
            const table = document.querySelector('#aDataInputs table');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td><input type="text" class="productInput" placeholder="è¼¸å…¥ç”¢å“åç¨±"></td>
                <td><input type="number" class="lotInput" value="0" min="0"></td>
                <td><input type="number" class="valueInput" placeholder="è¼¸å…¥æ•¸å€¼"></td>
                <td>
                    <select class="methodSelect">
                        <option value="O" selected>Override</option>
                        <option value="D">Direct</option>
                    </select>
                </td>
                <td><button class="delete-btn" onclick="deleteRow(this)">åˆªé™¤</button></td>
            `;
            
            table.appendChild(newRow);
        }

        // åˆªé™¤è¡Œ
        function deleteRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // æ”¶é›†Aæ•¸æ“š
        function collectAData() {
            aData = []; // æ¸…ç©ºç°æœ‰æ•°æ®
            
            const rows = document.querySelectorAll('#aDataInputs table tr:not(:first-child)');
            
            rows.forEach(row => {
                // è·å–äº§å“åç§° - ç»Ÿä¸€å¤„ç†æ–¹å¼
                let productName = '';
                const productInput = row.querySelector('.productInput');
                const productCell = row.querySelector('td:first-child');
                
                if (productInput) {
                    // æ–°å¢çš„è¡Œæœ‰è¾“å…¥æ¡†
                    productName = productInput.value.trim();
                } else if (productCell) {
                    // é¢„è®¾çš„è¡Œæ²¡æœ‰è¾“å…¥æ¡†ï¼Œç›´æ¥è·å–å•å…ƒæ ¼æ–‡æœ¬
                    productName = productCell.textContent.split(' ')[0].trim();
                }
                
                const lotInput = row.querySelector('.lotInput');
                const valueInput = row.querySelector('.valueInput');
                const methodSelect = row.querySelector('.methodSelect');
                
                // æ£€æŸ¥æ•°å€¼æ˜¯å¦ä¸º0æˆ–ç©ºï¼Œå¦‚æœæ˜¯åˆ™ä¸æ”¶é›†
                if (productName && valueInput && valueInput.value.trim() && !isNaN(valueInput.value.trim()) && parseFloat(valueInput.value.trim()) !== 0) {
                    const value = valueInput.value.trim();
                    const lot = lotInput.value.trim();
                    
                    aData.push({
                        product: productName,
                        value1: parseFloat(lot),
                        value2: parseFloat(value),
                        unit: '',
                        method: methodSelect.value
                    });
                }
            });
            
            updateAPreview();
        }

        // æ›´æ–°Aæ•¸æ“šé è¦½
        function updateAPreview() {
            const previewDiv = document.getElementById('aDataPreview');
            
            if (aData.length === 0) {
                previewDiv.innerHTML = '<p>å°šæœªæ·»åŠ ä»»ä½•æ•¸æ“š</p>';
                return;
            }
            
            let html = '<table style="width:100%;"><tr><th>ç”¢å“</th><th>æ‰‹æ•¸</th><th>æ•¸å€¼</th><th>æ–¹æ³•</th></tr>';
            
            aData.forEach((row, index) => {
                html += `<tr>
                    <td>${row.product}</td>
                    <td>${row.value1}</td>
                    <td>${row.value2}</td>
                    <td>${row.method === 'O' ? 'Override' : 'Direct'}</td>
                </tr>`;
            });
            
            html += '</table>';
            previewDiv.innerHTML = html;
        }

        // æ¸…ç©ºAæ•¸æ“š
        function clearA() {
            aData = [];
            document.querySelectorAll('.valueInput').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('.lotInput').forEach(input => {
                input.value = '0';
            });
            document.querySelectorAll('.productInput').forEach(input => {
                input.value = '';
            });
            // é‡ç½®æ–¹æ³•é€‰æ‹©
            document.querySelectorAll('.methodSelect').forEach((select, index) => {
                select.value = index === 0 ? 'D' : 'O'; // ç¬¬ä¸€ä¸ªæ˜¯STDï¼Œé»˜è®¤Dï¼Œå…¶ä»–é»˜è®¤O
            });
            updateAPreview();
        }

        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ‰æ•ˆç¯„åœå…§
        function isDateValid(startDate, endDate) {
            const today = new Date();
            
            if (startDate && startDate.trim() !== '') {
                const start = new Date(startDate.replace(/\//g, '-'));
                if (start > today) return false;
            }
            
            if (endDate && endDate.trim() !== '') {
                const end = new Date(endDate.replace(/\//g, '-'));
                if (end < today) return false;
            }
            
            return true;
        }

        // æ¯”è¼ƒå…©å€‹æ—¥æœŸï¼Œè¿”å›è¼ƒæ™šçš„æ—¥æœŸ
        function compareDates(date1, date2) {
            if (!date1 && !date2) return null;
            if (!date1) return date2;
            if (!date2) return date1;
            
            const d1 = new Date(date1.replace(/\//g, '-'));
            const d2 = new Date(date2.replace(/\//g, '-'));
            
            return d1 > d2 ? date1 : date2;
        }

        function parseAndCheck() {
            const tableB = document.getElementById('tableB').value;
            const tableC = document.getElementById('tableC').value;
            
            let debugHTML = '';
            let resultHTML = '';
            
            // è§£æBç¶²é æ•¸æ“šï¼ˆå®¢æˆ¶100åŸæ•¸å€¼ï¼‰
            const linesB = tableB.trim().split('\n');
            const dataB = [];
            let headersB = [];
            let skipNext = false;

            for (let i = 0; i < linesB.length; i++) {
                if (skipNext) {
                    skipNext = false;
                    continue;
                }
                
                const values = linesB[i].split('\t');
                
                if (i < 2) continue;
                
                if (i === 2) {
                    headersB = values;
                    continue;
                }
                
                if (values.length >= 3 && values[1] && (values[1].includes('Trade Comm') || values[1].includes('Trade Volume'))) {
                    if (values.length >= 8 && values[7]) {
                        dataB.push({
                            rebateType: values[1],
                            selection: values[2] === '*' ? 'STD' : values[2],
                            minLot: parseFloat(values[3]),
                            startDate: values[4],
                            endDate: values[5],
                            unit: values[6],
                            amount: parseFloat(values[7]),
                            method: values[8],
                            isValid: isDateValid(values[4], values[5])
                        });
                    } else {
                        if (i + 1 < linesB.length) {
                            const nextValues = linesB[i + 1].split('\t');
                            if (nextValues.length >= 3) {
                                dataB.push({
                                    rebateType: values[1],
                                    selection: values[2] === '*' ? 'STD' : values[2],
                                    minLot: parseFloat(values[3]),
                                    startDate: values[4],
                                    endDate: values[5] || '',
                                    unit: nextValues[0],
                                    amount: parseFloat(nextValues[1]),
                                    method: nextValues[2],
                                    isValid: isDateValid(values[4], values[5] || '')
                                });
                                skipNext = true;
                            }
                        }
                    }
                }
            }

            // è§£æCç¶²é æ•¸æ“šï¼ˆå®¢æˆ¶101æ•¸å€¼ï¼‰
            const linesC = tableC.trim().split('\n');
            const dataC = [];
            let headersC = [];
            skipNext = false;

            for (let i = 0; i < linesC.length; i++) {
                if (skipNext) {
                    skipNext = false;
                    continue;
                }
                
                const values = linesC[i].split('\t');
                
                if (i < 2) continue;
                
                if (i === 2) {
                    headersC = values;
                    continue;
                }
                
                if (values.length >= 3 && values[1] && (values[1].includes('Trade Comm') || values[1].includes('Trade Volume'))) {
                    if (values.length >= 8 && values[7]) {
                        dataC.push({
                            rebateType: values[1],
                            selection: values[2] === '*' ? 'STD' : values[2],
                            minLot: parseFloat(values[3]),
                            startDate: values[4],
                            endDate: values[5],
                            unit: values[6],
                            amount: parseFloat(values[7]),
                            method: values[8],
                            isValid: isDateValid(values[4], values[5])
                        });
                    } else {
                        if (i + 1 < linesC.length) {
                            const nextValues = linesC[i + 1].split('\t');
                            if (nextValues.length >= 3) {
                                dataC.push({
                                    rebateType: values[1],
                                    selection: values[2] === '*' ? 'STD' : values[2],
                                    minLot: parseFloat(values[3]),
                                    startDate: values[4],
                                    endDate: values[5] || '',
                                    unit: nextValues[0],
                                    amount: parseFloat(nextValues[1]),
                                    method: nextValues[2],
                                    isValid: isDateValid(values[4], values[5] || '')
                                });
                                skipNext = true;
                            }
                        }
                    }
                }
            }

            // åŸ·è¡Œæ ¸å°
            resultHTML += '<div class="debug-info"><h3>ğŸ“Š æœ€çµ‚æ ¸å°çµæœï¼š</h3>';
            resultHTML += '<table class="result-table"><tr><th>ç”¢å“</th><th>æ–°æ‰‹æ•¸</th><th>æ–°æ•¸å€¼</th><th>åŸæ•¸æ“šMin. Lot</th><th>åŸæ•¸å€¼</th><th>è®ŠåŒ–</th><th>åˆä½µå¾Œç”¢å“</th><th>åˆä½µå¾Œæ‰‹æ•¸</th><th>åˆä½µå¾Œæ•¸å€¼</th><th>ä¸Šç·šMin. Lot</th><th>ä¸Šç·šæ•¸å€¼</th><th>æ¯”è¼ƒçµæœ</th><th>æœ‰æ•ˆæœŸ</th></tr>';

            // å‰µå»ºä¸€å€‹åŒ…å«æ‰€æœ‰ç”¢å“å’Œæ‰‹æ•¸çµ„åˆçš„é›†åˆ
            const allProductLots = new Set();

            // æ·»åŠ Aæ•¸æ“šä¸­çš„ç”¢å“å’Œæ‰‹æ•¸çµ„åˆï¼ˆä½¿ç”¨æ¨™æº–åŒ–åç¨±ï¼‰
            aData.forEach(rowA => {
                const normalizedProduct = normalizeProductName(rowA.product);
                allProductLots.add(`${normalizedProduct}|${rowA.value1}`);
            });

            // æ·»åŠ Bæ•¸æ“šä¸­çš„æœ‰æ•ˆç”¢å“å’Œæ‰‹æ•¸çµ„åˆ
            dataB.forEach(rowB => {
                if (rowB.isValid) {
                    allProductLots.add(`${rowB.selection}|${rowB.minLot}`);
                }
            });

            // è™•ç†æ¯å€‹ç”¢å“å’Œæ‰‹æ•¸çµ„åˆ
            Array.from(allProductLots).forEach(productLot => {
                const [stdName, lot] = productLot.split('|');
                const productName = Object.entries(productMapping).find(([key, value]) => value === stdName)?.[0] || stdName;
                
                // æŸ¥æ‰¾Aæ•¸æ“šä¸­çš„ç‰¹å®šæ‰‹æ•¸è¨˜éŒ„ï¼ˆè€ƒæ…®åç¨±æ˜ å°„ï¼‰
                const rowA = aData.find(row => 
                    normalizeProductName(row.product) === stdName && row.value1 == lot
                );
                
                // æŸ¥æ‰¾Bæ•¸æ“šä¸­çš„æ‰€æœ‰æœ‰æ•ˆåŒ¹é…è¨˜éŒ„
                const matchesB = dataB.filter(rowB => 
                    rowB.selection === stdName && 
                    rowB.minLot == lot &&
                    rowB.isValid
                );
                
                // æŸ¥æ‰¾Cæ•¸æ“šä¸­çš„æ‰€æœ‰åŒ¹é…è¨˜éŒ„ï¼ˆåªæ¯”è¼ƒç›¸åŒç”¢å“ï¼Œä¸æ¯”è¼ƒæ‰‹æ•¸ï¼‰
                const matchesC = dataC.filter(rowC => 
                    rowC.selection === stdName
                );
                
                let aLot = 'N/A';
                let aValue = 'N/A';
                let aMethod = 'N/A';
                let originalValue = 'N/A';
                let bMinLot = 'N/A';
                let changeStatus = '';
                let changeClass = '';
                let mergedLot = 'N/A';
                let mergedValue = 'N/A';
                let customer101Value = 'N/A';
                let cMinLot = 'N/A';
                let comparisonResult = '';
                let validityStatus = '';
                let rowClass = 'not-found';
                
                // è™•ç†Aæ•¸æ“š
                if (rowA) {
                    aLot = rowA.value1;
                    aValue = rowA.value2;
                    aMethod = rowA.method === 'O' ? 'Override' : 'Direct';
                }
                
                // è™•ç†å®¢æˆ¶100åŸæ•¸å€¼(B)
                if (matchesB.length > 0) {
                    const selectedMatchB = matchesB.reduce((prev, current) => {
                        const prevDate = prev.endDate || '';
                        const currDate = current.endDate || '';
                        return compareDates(prevDate, currDate) === prevDate ? prev : current;
                    });
                    
                    originalValue = selectedMatchB.amount;
                    bMinLot = selectedMatchB.minLot;
                    
                    if (rowA) {
                        if (rowA.value2 > originalValue) {
                            changeStatus = 'â†‘ å¢åŠ ';
                            changeClass = 'increase';
                            mergedValue = rowA.value2;
                            mergedLot = rowA.value1;
                        } else if (rowA.value2 < originalValue) {
                            changeStatus = 'â†“ æ¸›å°‘';
                            changeClass = 'decrease';
                            mergedValue = rowA.value2;
                            mergedLot = rowA.value1;
                        } else {
                            changeStatus = 'â†’ ä¸è®Š';
                            changeClass = 'no-change';
                            mergedValue = originalValue;
                            mergedLot = rowA.value1;
                        }
                    } else {
                        mergedValue = originalValue;
                        mergedLot = bMinLot;
                        changeStatus = 'â†’ ç„¡Aæ•¸æ“š';
                        changeClass = 'no-change';
                    }
                    
                    validityStatus = 'æœ‰æ•ˆ';
                } else if (rowA) {
                    mergedValue = rowA.value2;
                    mergedLot = rowA.value1;
                    changeStatus = 'â†’ ç„¡æœ‰æ•ˆåŸæ•¸æ“š';
                    changeClass = 'no-change';
                    validityStatus = 'å¢åŠ æ–°æ•¸æ“š';
                }
                
                // è™•ç†ä¸Šç·šæ•¸å€¼(C)
                if (matchesC.length > 0) {
                    const validMatchesC = matchesC.filter(match => match.isValid);
                    const zeroLotMatches = validMatchesC.filter(match => match.minLot === 0);
                    
                    if (zeroLotMatches.length > 0) {
                        const selectedMatchC = zeroLotMatches.reduce((prev, current) => {
                            const prevDate = prev.endDate || '';
                            const currDate = current.endDate || '';
                            return compareDates(prevDate, currDate) === prevDate ? prev : current;
                        });
                        
                        customer101Value = selectedMatchC.amount;
                        cMinLot = selectedMatchC.minLot;
                        
                        if (mergedValue !== 'N/A') {
                            if (mergedValue > customer101Value) {
                                comparisonResult = 'è¶…éä¸Šç·š';
                                rowClass = 'fail';
                            } else {
                                comparisonResult = 'æœªè¶…éä¸Šç·š';
                                rowClass = 'pass';
                            }
                        } else {
                            comparisonResult = 'ç„¡åˆä½µæ•¸å€¼å¯æ¯”è¼ƒ';
                            rowClass = 'not-found';
                        }
                    } else {
                        comparisonResult = 'ä¸Šç·šæ²’æœ‰è©²ç”¢å“(ç„¡0æ‰‹æ•¸è¨˜éŒ„)';
                        rowClass = 'fail';
                        customer101Value = 'N/A';
                        cMinLot = 'N/A';
                    }
                } else {
                    comparisonResult = 'ä¸Šç·šæ²’æœ‰è©²ç”¢å“';
                    rowClass = 'fail';
                    customer101Value = 'N/A';
                    cMinLot = 'N/A';
                }
                
                resultHTML += `<tr class="${rowClass}">
                    <td>${productName}</td>
                    <td>${aLot}</td>
                    <td>${aValue}</td>
                    <td>${bMinLot}</td>
                    <td>${originalValue}</td>
                    <td class="${changeClass}">${changeStatus}</td>
                    <td>${stdName}</td>
                    <td>${mergedLot}</td>
                    <td>${mergedValue}</td>
                    <td>${cMinLot}</td>
                    <td>${customer101Value}</td>
                    <td><strong>${comparisonResult}</strong></td>
                    <td>${validityStatus}</td>
                </tr>`;
            });
            
            resultHTML += '</table></div>';
            
            document.getElementById('finalResult').innerHTML = resultHTML;

            debugHTML = '<div class="debug-info"><h3>è§£æå¾Œçš„Aæ•¸æ“šï¼ˆæ–°æ•¸å€¼ï¼‰ï¼š</h3><table><tr><th>ç”¢å“</th><th>æ‰‹æ•¸</th><th>æ•¸å€¼</th><th>æ–¹æ³•</th></tr>';
            aData.forEach(row => {
                debugHTML += `<tr><td>${row.product}</td><td>${row.value1}</td><td>${row.value2}</td><td>${row.method === 'O' ? 'Override' : 'Direct'}</td></tr>`;
            });
            debugHTML += '</table></div>';

            debugHTML += '<div class="debug-info"><h3>è§£æå¾Œçš„Bæ•¸æ“šï¼ˆåŸæ•¸å€¼ï¼‰ï¼š</h3><table><tr><th>Rebate Type</th><th>Selection</th><th>Min. Lot</th><th>Start Date</th><th>End Date</th><th>Unit</th><th>Amount</th><th>Method</th><th>æœ‰æ•ˆ</th></tr>';
            dataB.forEach(row => {
                debugHTML += `<tr>
                    <td>${row.rebateType}</td>
                    <td>${row.selection}</td>
                    <td>${row.minLot}</td>
                    <td>${row.startDate || 'ç„¡é™æœŸ'}</td>
                    <td>${row.endDate || 'ç„¡é™æœŸ'}</td>
                    <td>${row.unit}</td>
                    <td>${row.amount}</td>
                    <td>${row.method}</td>
                    <td>${row.isValid ? 'æ˜¯' : 'å¦'}</td>
                </tr>`;
            });
            debugHTML += '</table></div>';

            debugHTML += '<div class="debug-info"><h3>è§£æå¾Œçš„Cæ•¸æ“šï¼ˆä¸Šç·šæ•¸å€¼ï¼‰ï¼š</h3><table><tr><th>Rebate Type</th><th>Selection</th><th>Min. Lot</th><th>Start Date</th><th>End Date</th><th>Unit</th><th>Amount</th><th>Method</th><th>æœ‰æ•ˆ</th></tr>';
            dataC.forEach(row => {
                debugHTML += `<tr>
                    <td>${row.rebateType}</td>
                    <td>${row.selection}</td>
                    <td>${row.minLot}</td>
                    <td>${row.startDate || 'ç„¡é™æœŸ'}</td>
                    <td>${row.endDate || 'ç„¡é™æœŸ'}</td>
                    <td>${row.unit}</td>
                    <td>${row.amount}</td>
                    <td>${row.method}</td>
                    <td>${row.isValid ? 'æ˜¯' : 'å¦'}</td>
                </tr>`;
            });
            debugHTML += '</table></div>';

            document.getElementById('debugResult').innerHTML = debugHTML;
        }
        
        function clearAll() {
            aData = [];
            document.querySelectorAll('.valueInput').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('.lotInput').forEach(input => {
                input.value = '0';
            });
            document.querySelectorAll('.productInput').forEach(input => {
                input.value = '';
            });
            // é‡ç½®æ–¹æ³•é€‰æ‹©
            document.querySelectorAll('.methodSelect').forEach((select, index) => {
                select.value = index === 0 ? 'D' : 'O'; // ç¬¬ä¸€ä¸ªæ˜¯STDï¼Œé»˜è®¤Dï¼Œå…¶ä»–é»˜è®¤O
            });
            document.getElementById('tableB').value = '';
            document.getElementById('tableC').value = '';
            document.getElementById('debugResult').innerHTML = '';
            document.getElementById('finalResult').innerHTML = '';
            updateAPreview();
        }
    </script>
</body>
</html>
