<!DOCTYPE html>
<html>
<head>
    <title>Bonus UpdateÊï∏ÊìöÊØîËºÉÂ∑•ÂÖ∑</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f8ff; }
        .container { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 20px; max-width: 2000px; margin: 0 auto; }
        .section { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 300px; padding: 10px; border: 2px solid #007bff; border-radius: 5px; font-family: monospace; }
        button { background: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 2px solid #ddd; padding: 10px; text-align: center; }
        th { background: #e9ecef; font-weight: bold; }
        .debug-info { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .result-table { background: #f8f9fa; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        .not-found { background: #fff3cd; }
        .hidden { display: none; }
        .increase { color: green; font-weight: bold; }
        .decrease { color: red; font-weight: bold; }
        .no-change { color: blue; font-weight: bold; }
        .expired { color: #999; text-decoration: line-through; }
        .no-product { color: #6c757d; font-weight: bold; }
        select { width: 100%; padding: 10px; border: 2px solid #007bff; border-radius: 5px; margin-bottom: 10px; }
        .select-group { margin-bottom: 15px; }
        .select-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 10px; border: 2px solid #007bff; border-radius: 5px; }
        #aDataInputs table input[type="number"] { width: 80%; }
        #aDataInputs { max-height: 500px; overflow-y: auto; }
        .method-select { width: 120px; }
        .add-product-btn { background: #28a745; margin: 10px 5px; }
        .add-product-btn:hover { background: #218838; }
        .delete-btn { background: #dc3545; padding: 5px 10px; margin-left: 5px; }
        .delete-btn:hover { background: #c82333; }
        .primary-btn { 
            background: #007bff; 
            font-weight: bold; 
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .primary-btn:hover { background: #0056b3; }
        .action-btn { 
            background: #6c757d; 
            font-weight: bold; 
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .action-btn:hover { background: #5a6268; }
        .important-btn { 
            background: #28a745; 
            font-weight: bold; 
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .important-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <h1>üîç Bonus Update ÊØîËºÉÂ∑•ÂÖ∑</h1>
    
    <div class="container">
        <div class="section">
            <h2>üìã AÊï∏ÊìöÔºàÊñ∞Êï∏ÂÄºÔºâ</h2>
            
            <div id="aDataInputs">
                <table>
                    <tr>
                        <th>Áî¢ÂìÅ</th>
                        <th>ÊâãÊï∏</th>
                        <th>Êï∏ÂÄº</th>
                        <th>ÊñπÊ≥ï</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                    <tr>
                        <td>STD (Ê®ôÊ∫ñ)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="D" selected>Direct</option>
                                <option value="O">Override</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Forex (Â§ñÂåØ)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Gold (ÈªÉÈáë)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Silver (ÁôΩÈäÄ)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Oil (ÂéüÊ≤π)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GASUSD (Â§©ÁÑ∂Ê∞£)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>HKG33 (ÊÅíÁîüÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>NAS100 (Á¥çÊñØÈÅîÂÖã100ÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>SPX500 (Ê®ôÊôÆ500ÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>US30 (ÈÅìÁìäÊñØÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>A50 (‰∏≠ËèØA50ÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>JPN225 (Êó•Á∂ì225ÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GER30 (Âæ∑ÂúãDAXÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>GAUCNH (‰∫∫Ê∞ëÂπ£ÈªÉÈáë)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>AUS200 (Êæ≥Ê¥≤200ÊåáÊï∏)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>ECN (ECN)</td>
                        <td><input type="number" class="lotInput" value="0" min="0"></td>
                        <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                        <td>
                            <select class="methodSelect">
                                <option value="O" selected>Override</option>
                                <option value="D">Direct</option>
                            </select>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </div>
            
            <button class="important-btn" onclick="collectAData()">Êî∂ÈõÜAÊï∏Êìö</button>
            <button class="action-btn" onclick="clearA()">Ê∏ÖÁ©∫AÊï∏Êìö</button>
            <button class="add-product-btn" onclick="addProductRow()">‚ûï Êñ∞Â¢ûÁî¢ÂìÅ</button>
            
            <div id="aDataPreview" style="margin-top: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                <p>Â∞öÊú™Ê∑ªÂä†‰ªª‰ΩïÊï∏Êìö</p>
            </div>
            
            <input type="hidden" id="tableA" value="">
        </div>

        <div class="section">
            <h2>üìã BÊï∏ÊìöÔºàÂéüÊï∏ÂÄºÔºâ</h2>
            <textarea id="tableB" placeholder="Ë´ãË≤º‰∏äBÁ∂≤È†ÅÁöÑË°®Ê†ºÊï∏Êìö..."></textarea>
        </div>

        <div class="section">
            <h2>üìã CÊï∏ÊìöÔºà‰∏äÁ∑öÊï∏ÂÄºÔºâ</h2>
            <textarea id="tableC" placeholder="Ë´ãË≤º‰∏äCÁ∂≤È†ÅÁöÑË°®Ê†ºÊï∏Êìö..."></textarea>
        </div>

        <div class="section" style="grid-column: 1 / -1;">
            <h2>üìä Ëß£ÊûêËàáÊ†∏Â∞çÁµêÊûú</h2>
            <button class="important-btn" onclick="parseAndCheck()">ÈñãÂßãËß£ÊûêËàáÊ†∏Â∞ç</button>
            <button class="action-btn" onclick="clearAll()">Ê∏ÖÁ©∫ÊâÄÊúâ</button>
            
            <div id="finalResult"></div>
            <div id="debugResult"></div>
        </div>
    </div>

    <script>
        // Áî¢ÂìÅÂêçÁ®±Êò†Â∞ÑË°®
        const productMapping = {
            'Forex': 'STD_FX',
            'Â§ñÂåØ': 'STD_FX',
            'Gold': 'STD_GOLD',
            'ÈªÉÈáë': 'STD_GOLD',
            'Silver': 'STD_SILVER',
            'ÁôΩÈäÄ': 'STD_SILVER',
            'Oil': 'STD_OIL',
            'ÂéüÊ≤π': 'STD_OIL',
            'GASUSD': 'STD_GAS',
            'Â§©ÁÑ∂Ê∞£': 'STD_GAS',
            'HKG33': 'STD_HKG33',
            'ÊÅíÁîüÊåáÊï∏': 'STD_HKG33',
            'NAS100': 'STD_NAS100',
            'Á¥çÊñØÈÅîÂÖã100ÊåáÊï∏': 'STD_NAS100',
            'SPX500': 'STD_SPX500',
            'Ê®ôÊôÆ500ÊåáÊï∏': 'STD_SPX500',
            'US30': 'STD_US30',
            'ÈÅìÁìäÊñØÊåáÊï∏': 'STD_US30',
            'A50': 'STD_A50',
            '‰∏≠ËèØA50ÊåáÊï∏': 'STD_A50',
            'JPN225': 'STD_JPN225',
            'Êó•Á∂ì225ÊåáÊï∏': 'STD_JPN225',
            'GER30': 'STD_GER30',
            'Âæ∑ÂúãDAXÊåáÊï∏': 'STD_GER30',
            'GAUCNH': 'STD_GAUCNH',
            '‰∫∫Ê∞ëÂπ£ÈªÉÈáë': 'STD_GAUCNH',
            'AUS200': 'STD_AUS200',
            'Êæ≥Ê¥≤200ÊåáÊï∏': 'STD_AUS200',
            'STD': 'STD',
            'Ê®ôÊ∫ñ': 'STD',
            '*': 'STD'
        };

        // Â≠òÂÑ≤AÊï∏ÊìöÁöÑÊï∏ÁµÑ
        let aData = [];

        // Ê®ôÊ∫ñÂåñÁî¢ÂìÅÂêçÁ®±
        function normalizeProductName(productName) {
            return productMapping[productName] || productName;
        }

        // Êñ∞Â¢ûÁî¢ÂìÅË°å
        function addProductRow() {
            const table = document.querySelector('#aDataInputs table');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td><input type="text" class="productInput" placeholder="Ëº∏ÂÖ•Áî¢ÂìÅÂêçÁ®±"></td>
                <td><input type="number" class="lotInput" value="0" min="0"></td>
                <td><input type="number" class="valueInput" placeholder="Ëº∏ÂÖ•Êï∏ÂÄº"></td>
                <td>
                    <select class="methodSelect">
                        <option value="O" selected>Override</option>
                        <option value="D">Direct</option>
                    </select>
                </td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Âà™Èô§</button></td>
            `;
            
            table.appendChild(newRow);
        }

        // Âà™Èô§Ë°å
        function deleteRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Êî∂ÈõÜAÊï∏Êìö
        function collectAData() {
            aData = []; // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
            
            const rows = document.querySelectorAll('#aDataInputs table tr:not(:first-child)');
            
            rows.forEach(row => {
                // Ëé∑Âèñ‰∫ßÂìÅÂêçÁß∞ - Áªü‰∏ÄÂ§ÑÁêÜÊñπÂºè
                let productName = '';
                const productInput = row.querySelector('.productInput');
                const productCell = row.querySelector('td:first-child');
                
                if (productInput) {
                    // Êñ∞Â¢ûÁöÑË°åÊúâËæìÂÖ•Ê°Ü
                    productName = productInput.value.trim();
                } else if (productCell) {
                    // È¢ÑËÆæÁöÑË°åÊ≤°ÊúâËæìÂÖ•Ê°ÜÔºåÁõ¥Êé•Ëé∑ÂèñÂçïÂÖÉÊ†ºÊñáÊú¨
                    productName = productCell.textContent.split(' ')[0].trim();
                }
                
                const lotInput = row.querySelector('.lotInput');
                const valueInput = row.querySelector('.valueInput');
                const methodSelect = row.querySelector('.methodSelect');
                
                // Ê£ÄÊü•Êï∞ÂÄºÊòØÂê¶‰∏∫0ÊàñÁ©∫ÔºåÂ¶ÇÊûúÊòØÂàô‰∏çÊî∂ÈõÜ
                if (productName && valueInput && valueInput.value.trim() && !isNaN(valueInput.value.trim()) && parseFloat(valueInput.value.trim()) !== 0) {
                    const value = valueInput.value.trim();
                    const lot = lotInput.value.trim();
                    
                    aData.push({
                        product: productName,
                        value1: parseFloat(lot),
                        value2: parseFloat(value),
                        unit: '',
                        method: methodSelect.value
                    });
                }
            });
            
            updateAPreview();
        }

        // Êõ¥Êñ∞AÊï∏ÊìöÈ†êË¶Ω
        function updateAPreview() {
            const previewDiv = document.getElementById('aDataPreview');
            
            if (aData.length === 0) {
                previewDiv.innerHTML = '<p>Â∞öÊú™Ê∑ªÂä†‰ªª‰ΩïÊï∏Êìö</p>';
                return;
            }
            
            let html = '<table style="width:100%;"><tr><th>Áî¢ÂìÅ</th><th>ÊâãÊï∏</th><th>Êï∏ÂÄº</th><th>ÊñπÊ≥ï</th></tr>';
            
            aData.forEach((row, index) => {
                html += `<tr>
                    <td>${row.product}</td>
                    <td>${row.value1}</td>
                    <td>${row.value2}</td>
                    <td>${row.method === 'O' ? 'Override' : 'Direct'}</td>
                </tr>`;
            });
            
            html += '</table>';
            previewDiv.innerHTML = html;
        }

        // Ê∏ÖÁ©∫AÊï∏Êìö
        function clearA() {
            aData = [];
            document.querySelectorAll('.valueInput').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('.lotInput').forEach(input => {
                input.value = '0';
            });
            document.querySelectorAll('.productInput').forEach(input => {
                input.value = '';
            });
            // ÈáçÁΩÆÊñπÊ≥ïÈÄâÊã©
            document.querySelectorAll('.methodSelect').forEach((select, index) => {
                select.value = index === 0 ? 'D' : 'O'; // Á¨¨‰∏Ä‰∏™ÊòØSTDÔºåÈªòËÆ§DÔºåÂÖ∂‰ªñÈªòËÆ§O
            });
            updateAPreview();
        }

        // Ê™¢Êü•Êó•ÊúüÊòØÂê¶Âú®ÊúâÊïàÁØÑÂúçÂÖß
        function isDateValid(startDate, endDate) {
            const today = new Date();
            
            if (startDate && startDate.trim() !== '') {
                const start = new Date(startDate.replace(/\//g, '-'));
                if (start > today) return false;
            }
            
            if (endDate && endDate.trim() !== '') {
                const end = new Date(endDate.replace(/\//g, '-'));
                if (end < today) return false;
            }
            
            return true;
        }

        // ÊØîËºÉÂÖ©ÂÄãÊó•ÊúüÔºåËøîÂõûËºÉÊôöÁöÑÊó•Êúü
        function compareDates(date1, date2) {
            if (!date1 && !date2) return null;
            if (!date1) return date2;
            if (!date2) return date1;
            
            const d1 = new Date(date1.replace(/\//g, '-'));
            const d2 = new Date(date2.replace(/\//g, '-'));
            
            return d1 > d2 ? date1 : date2;
        }

        function parseAndCheck() {
            const tableB = document.getElementById('tableB').value;
            const tableC = document.getElementById('tableC').value;
            
            let debugHTML = '';
            let resultHTML = '';
            
            // Ëß£ÊûêBÁ∂≤È†ÅÊï∏ÊìöÔºàÂÆ¢Êà∂100ÂéüÊï∏ÂÄºÔºâ
            const linesB = tableB.trim().split('\n');
            const dataB = [];
            let headersB = [];
            let skipNext = false;

            for (let i = 0; i < linesB.length; i++) {
                if (skipNext) {
                    skipNext = false;
                    continue;
                }
                
                const values = linesB[i].split('\t');
                
                if (i < 2) continue;
                
                if (i === 2) {
                    headersB = values;
                    continue;
                }
                
                if (values.length >= 3 && values[1] && (values[1].includes('Trade Comm') || values[1].includes('Trade Volume'))) {
                    if (values.length >= 8 && values[7]) {
                        dataB.push({
                            rebateType: values[1],
                            selection: values[2] === '*' ? 'STD' : values[2],
                            minLot: parseFloat(values[3]),
                            startDate: values[4],
                            endDate: values[5],
                            unit: values[6],
                            amount: parseFloat(values[7]),
                            method: values[8],
                            isValid: isDateValid(values[4], values[5])
                        });
                    } else {
                        if (i + 1 < linesB.length) {
                            const nextValues = linesB[i + 1].split('\t');
                            if (nextValues.length >= 3) {
                                dataB.push({
                                    rebateType: values[1],
                                    selection: values[2] === '*' ? 'STD' : values[2],
                                    minLot: parseFloat(values[3]),
                                    startDate: values[4],
                                    endDate: values[5] || '',
                                    unit: nextValues[0],
                                    amount: parseFloat(nextValues[1]),
                                    method: nextValues[2],
                                    isValid: isDateValid(values[4], values[5] || '')
                                });
                                skipNext = true;
                            }
                        }
                    }
                }
            }

            // Ëß£ÊûêCÁ∂≤È†ÅÊï∏ÊìöÔºàÂÆ¢Êà∂101Êï∏ÂÄºÔºâ
            const linesC = tableC.trim().split('\n');
            const dataC = [];
            let headersC = [];
            skipNext = false;

            for (let i = 0; i < linesC.length; i++) {
                if (skipNext) {
                    skipNext = false;
                    continue;
                }
                
                const values = linesC[i].split('\t');
                
                if (i < 2) continue;
                
                if (i === 2) {
                    headersC = values;
                    continue;
                }
                
                if (values.length >= 3 && values[1] && (values[1].includes('Trade Comm') || values[1].includes('Trade Volume'))) {
                    if (values.length >= 8 && values[7]) {
                        dataC.push({
                            rebateType: values[1],
                            selection: values[2] === '*' ? 'STD' : values[2],
                            minLot: parseFloat(values[3]),
                            startDate: values[4],
                            endDate: values[5],
                            unit: values[6],
                            amount: parseFloat(values[7]),
                            method: values[8],
                            isValid: isDateValid(values[4], values[5])
                        });
                    } else {
                        if (i + 1 < linesC.length) {
                            const nextValues = linesC[i + 1].split('\t');
                            if (nextValues.length >= 3) {
                                dataC.push({
                                    rebateType: values[1],
                                    selection: values[2] === '*' ? 'STD' : values[2],
                                    minLot: parseFloat(values[3]),
                                    startDate: values[4],
                                    endDate: values[5] || '',
                                    unit: nextValues[0],
                                    amount: parseFloat(nextValues[1]),
                                    method: nextValues[2],
                                    isValid: isDateValid(values[4], values[5] || '')
                                });
                                skipNext = true;
                            }
                        }
                    }
                }
            }

            // Âü∑Ë°åÊ†∏Â∞ç
            resultHTML += '<div class="debug-info"><h3>üìä ÊúÄÁµÇÊ†∏Â∞çÁµêÊûúÔºö</h3>';
            resultHTML += '<table class="result-table"><tr><th>Áî¢ÂìÅ</th><th>Êñ∞ÊâãÊï∏</th><th>Êñ∞Êï∏ÂÄº</th><th>ÂéüÊï∏ÊìöMin. Lot</th><th>ÂéüÊï∏ÂÄº</th><th>ËÆäÂåñ</th><th>Âêà‰ΩµÂæåÁî¢ÂìÅ</th><th>Âêà‰ΩµÂæåÊâãÊï∏</th><th>Âêà‰ΩµÂæåÊï∏ÂÄº</th><th>‰∏äÁ∑öMin. Lot</th><th>‰∏äÁ∑öÊï∏ÂÄº</th><th>ÊØîËºÉÁµêÊûú</th><th>ÊúâÊïàÊúü</th></tr>';

            // ÂâµÂª∫‰∏ÄÂÄãÂåÖÂê´ÊâÄÊúâÁî¢ÂìÅÂíåÊâãÊï∏ÁµÑÂêàÁöÑÈõÜÂêà
            const allProductLots = new Set();

            // Ê∑ªÂä†AÊï∏Êìö‰∏≠ÁöÑÁî¢ÂìÅÂíåÊâãÊï∏ÁµÑÂêàÔºà‰ΩøÁî®Ê®ôÊ∫ñÂåñÂêçÁ®±Ôºâ
            aData.forEach(rowA => {
                const normalizedProduct = normalizeProductName(rowA.product);
                allProductLots.add(`${normalizedProduct}|${rowA.value1}`);
            });

            // Ê∑ªÂä†BÊï∏Êìö‰∏≠ÁöÑÊúâÊïàÁî¢ÂìÅÂíåÊâãÊï∏ÁµÑÂêà
            dataB.forEach(rowB => {
                if (rowB.isValid) {
                    allProductLots.add(`${rowB.selection}|${rowB.minLot}`);
                }
            });

            // ËôïÁêÜÊØèÂÄãÁî¢ÂìÅÂíåÊâãÊï∏ÁµÑÂêà
            Array.from(allProductLots).forEach(productLot => {
                const [stdName, lot] = productLot.split('|');
                const productName = Object.entries(productMapping).find(([key, value]) => value === stdName)?.[0] || stdName;
                
                // Êü•ÊâæAÊï∏Êìö‰∏≠ÁöÑÁâπÂÆöÊâãÊï∏Ë®òÈåÑÔºàËÄÉÊÖÆÂêçÁ®±Êò†Â∞ÑÔºâ
                const rowA = aData.find(row => 
                    normalizeProductName(row.product) === stdName && row.value1 == lot
                );
                
                // Êü•ÊâæBÊï∏Êìö‰∏≠ÁöÑÊâÄÊúâÊúâÊïàÂåπÈÖçË®òÈåÑ
                const matchesB = dataB.filter(rowB => 
                    rowB.selection === stdName && 
                    rowB.minLot == lot &&
                    rowB.isValid
                );
                
                // Êü•ÊâæCÊï∏Êìö‰∏≠ÁöÑÊâÄÊúâÂåπÈÖçË®òÈåÑÔºàÂè™ÊØîËºÉÁõ∏ÂêåÁî¢ÂìÅÔºå‰∏çÊØîËºÉÊâãÊï∏Ôºâ
                const matchesC = dataC.filter(rowC => 
                    rowC.selection === stdName
                );
                
                let aLot = 'N/A';
                let aValue = 'N/A';
                let aMethod = 'N/A';
                let originalValue = 'N/A';
                let bMinLot = 'N/A';
                let changeStatus = '';
                let changeClass = '';
                let mergedLot = 'N/A';
                let mergedValue = 'N/A';
                let customer101Value = 'N/A';
                let cMinLot = 'N/A';
                let comparisonResult = '';
                let validityStatus = '';
                let rowClass = 'not-found';
                
                // ËôïÁêÜAÊï∏Êìö
                if (rowA) {
                    aLot = rowA.value1;
                    aValue = rowA.value2;
                    aMethod = rowA.method === 'O' ? 'Override' : 'Direct';
                }
                
                // ËôïÁêÜÂÆ¢Êà∂100ÂéüÊï∏ÂÄº(B)
                if (matchesB.length > 0) {
                    const selectedMatchB = matchesB.reduce((prev, current) => {
                        const prevDate = prev.endDate || '';
                        const currDate = current.endDate || '';
                        return compareDates(prevDate, currDate) === prevDate ? prev : current;
                    });
                    
                    originalValue = selectedMatchB.amount;
                    bMinLot = selectedMatchB.minLot;
                    
                    if (rowA) {
                        if (rowA.value2 > originalValue) {
                            changeStatus = '‚Üë Â¢ûÂä†';
                            changeClass = 'increase';
                            mergedValue = rowA.value2;
                            mergedLot = rowA.value1;
                        } else if (rowA.value2 < originalValue) {
                            changeStatus = '‚Üì Ê∏õÂ∞ë';
                            changeClass = 'decrease';
                            mergedValue = rowA.value2;
                            mergedLot = rowA.value1;
                        } else {
                            changeStatus = '‚Üí ‰∏çËÆä';
                            changeClass = 'no-change';
                            mergedValue = originalValue;
                            mergedLot = rowA.value1;
                        }
                    } else {
                        mergedValue = originalValue;
                        mergedLot = bMinLot;
                        changeStatus = '‚Üí ÁÑ°AÊï∏Êìö';
                        changeClass = 'no-change';
                    }
                    
                    validityStatus = 'ÊúâÊïà';
                } else if (rowA) {
                    mergedValue = rowA.value2;
                    mergedLot = rowA.value1;
                    changeStatus = '‚Üí ÁÑ°ÊúâÊïàÂéüÊï∏Êìö';
                    changeClass = 'no-change';
                    validityStatus = 'Â¢ûÂä†Êñ∞Êï∏Êìö';
                }
                
                // ËôïÁêÜ‰∏äÁ∑öÊï∏ÂÄº(C)
                if (matchesC.length > 0) {
                    const validMatchesC = matchesC.filter(match => match.isValid);
                    const zeroLotMatches = validMatchesC.filter(match => match.minLot === 0);
                    
                    if (zeroLotMatches.length > 0) {
                        const selectedMatchC = zeroLotMatches.reduce((prev, current) => {
                            const prevDate = prev.endDate || '';
                            const currDate = current.endDate || '';
                            return compareDates(prevDate, currDate) === prevDate ? prev : current;
                        });
                        
                        customer101Value = selectedMatchC.amount;
                        cMinLot = selectedMatchC.minLot;
                        
                        if (mergedValue !== 'N/A') {
                            if (mergedValue > customer101Value) {
                                comparisonResult = 'Ë∂ÖÈÅé‰∏äÁ∑ö';
                                rowClass = 'fail';
                            } else {
                                comparisonResult = 'Êú™Ë∂ÖÈÅé‰∏äÁ∑ö';
                                rowClass = 'pass';
                            }
                        } else {
                            comparisonResult = 'ÁÑ°Âêà‰ΩµÊï∏ÂÄºÂèØÊØîËºÉ';
                            rowClass = 'not-found';
                        }
                    } else {
                        comparisonResult = '‰∏äÁ∑öÊ≤íÊúâË©≤Áî¢ÂìÅ(ÁÑ°0ÊâãÊï∏Ë®òÈåÑ)';
                        rowClass = 'fail';
                        customer101Value = 'N/A';
                        cMinLot = 'N/A';
                    }
                } else {
                    comparisonResult = '‰∏äÁ∑öÊ≤íÊúâË©≤Áî¢ÂìÅ';
                    rowClass = 'fail';
                    customer101Value = 'N/A';
                    cMinLot = 'N/A';
                }
                
                resultHTML += `<tr class="${rowClass}">
                    <td>${productName}</td>
                    <td>${aLot}</td>
                    <td>${aValue}</td>
                    <td>${bMinLot}</td>
                    <td>${originalValue}</td>
                    <td class="${changeClass}">${changeStatus}</td>
                    <td>${stdName}</td>
                    <td>${mergedLot}</td>
                    <td>${mergedValue}</td>
                    <td>${cMinLot}</td>
                    <td>${customer101Value}</td>
                    <td><strong>${comparisonResult}</strong></td>
                    <td>${validityStatus}</td>
                </tr>`;
            });
            
            resultHTML += '</table></div>';
            
            document.getElementById('finalResult').innerHTML = resultHTML;

            debugHTML = '<div class="debug-info"><h3>Ëß£ÊûêÂæåÁöÑAÊï∏ÊìöÔºàÊñ∞Êï∏ÂÄºÔºâÔºö</h3><table><tr><th>Áî¢ÂìÅ</th><th>ÊâãÊï∏</th><th>Êï∏ÂÄº</th><th>ÊñπÊ≥ï</th></tr>';
            aData.forEach(row => {
                debugHTML += `<tr><td>${row.product}</td><td>${row.value1}</td><td>${row.value2}</td><td>${row.method === 'O' ? 'Override' : 'Direct'}</td></tr>`;
            });
            debugHTML += '</table></div>';

            debugHTML += '<div class="debug-info"><h3>Ëß£ÊûêÂæåÁöÑBÊï∏ÊìöÔºàÂéüÊï∏ÂÄºÔºâÔºö</h3><table><tr><th>Rebate Type</th><th>Selection</th><th>Min. Lot</th><th>Start Date</th><th>End Date</th><th>Unit</th><th>Amount</th><th>Method</th><th>ÊúâÊïà</th></tr>';
            dataB.forEach(row => {
                debugHTML += `<tr>
                    <td>${row.rebateType}</td>
                    <td>${row.selection}</td>
                    <td>${row.minLot}</td>
                    <td>${row.startDate || 'ÁÑ°ÈôêÊúü'}</td>
                    <td>${row.endDate || 'ÁÑ°ÈôêÊúü'}</td>
                    <td>${row.unit}</td>
                    <td>${row.amount}</td>
                    <td>${row.method}</td>
                    <td>${row.isValid ? 'ÊòØ' : 'Âê¶'}</td>
                </tr>`;
            });
            debugHTML += '</table></div>';

            debugHTML += '<div class="debug-info"><h3>Ëß£ÊûêÂæåÁöÑCÊï∏ÊìöÔºà‰∏äÁ∑öÊï∏ÂÄºÔºâÔºö</h3><table><tr><th>Rebate Type</th><th>Selection</th><th>Min. Lot</th><th>Start Date</th><th>End Date</th><th>Unit</th><th>Amount</th><th>Method</th><th>ÊúâÊïà</th></tr>';
            dataC.forEach(row => {
                debugHTML += `<tr>
                    <td>${row.rebateType}</td>
                    <td>${row.selection}</td>
                    <td>${row.minLot}</td>
                    <td>${row.startDate || 'ÁÑ°ÈôêÊúü'}</td>
                    <td>${row.endDate || 'ÁÑ°ÈôêÊúü'}</td>
                    <td>${row.unit}</td>
                    <td>${row.amount}</td>
                    <td>${row.method}</td>
                    <td>${row.isValid ? 'ÊòØ' : 'Âê¶'}</td>
                </tr>`;
            });
            debugHTML += '</table></div>';

            document.getElementById('debugResult').innerHTML = debugHTML;
        }
        
        function clearAll() {
            aData = [];
            document.querySelectorAll('.valueInput').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('.lotInput').forEach(input => {
                input.value = '0';
            });
            document.querySelectorAll('.productInput').forEach(input => {
                input.value = '';
            });
            // ÈáçÁΩÆÊñπÊ≥ïÈÄâÊã©
            document.querySelectorAll('.methodSelect').forEach((select, index) => {
                select.value = index === 0 ? 'D' : 'O'; // Á¨¨‰∏Ä‰∏™ÊòØSTDÔºåÈªòËÆ§DÔºåÂÖ∂‰ªñÈªòËÆ§O
            });
            document.getElementById('tableB').value = '';
            document.getElementById('tableC').value = '';
            document.getElementById('debugResult').innerHTML = '';
            document.getElementById('finalResult').innerHTML = '';
            updateAPreview();
        }
    </script>
</body>
</html>
